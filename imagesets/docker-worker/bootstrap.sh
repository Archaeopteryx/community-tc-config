#!/bin/bash

set -exv
exec &> /var/log/bootstrap.log

for CERT_FILE in /etc/star_taskcluster-worker_net.crt /etc/taskcluster/secrets/worker_livelog_tls_cert; do
  if [ -f "${CERT_FILE}" ]; then

    echo '-----BEGIN CERTIFICATE-----
MIIHCjCCBfKgAwIBAgIQBqq4YrZnRTR49fBnhGApuzANBgkqhkiG9w0BAQsFADBZ
MQswCQYDVQQGEwJVUzEVMBMGA1UEChMMRGlnaUNlcnQgSW5jMTMwMQYDVQQDEypE
aWdpQ2VydCBHbG9iYWwgRzIgVExTIFJTQSBTSEEyNTYgMjAyMCBDQTEwHhcNMjMw
NjEzMDAwMDAwWhcNMjQwNjE3MjM1OTU5WjB7MQswCQYDVQQGEwJVUzETMBEGA1UE
CBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZyYW5jaXNjbzEcMBoGA1UEChMT
TW96aWxsYSBDb3Jwb3JhdGlvbjEhMB8GA1UEAwwYKi50YXNrY2x1c3Rlci13b3Jr
ZXIubmV0MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA4ucNh32/dYp0
O3J559aRy6+QqYv1yxJcAZ63UlQCBpKQDZZraqGyyQy+MjhP3KmHkkNfrTozReSG
1Z6V0X8voLHKU9f2tVE5nDiX9v6XHT7xyEs9FTOZPQFNfLHnGAwjRbAhw14ROr2m
KHqETYqVF3HZbxxwX2mODSUwbs02mbQTWAhMZdUdkNTaFrSVsoCY9KQod3FfUc4j
vUJHhj/lgjtoyna8SbFMiHguoAz0c25QWRwi9FeejWd16mWj0ZudGKXbE5iTB2dC
ukiJgHwJ4yd7uRFL8fUNpi+zoXICDzhJrUHI/n8IRM2+pibCFhPaNTHcbq9jbzQz
Ylkb/GyDOwIDAQABo4IDqjCCA6YwHwYDVR0jBBgwFoAUdIWAwGbH3zfez70pN6oD
Hb7tzRcwHQYDVR0OBBYEFCVkgqudCRDFcOUkdC+5TdrmvMm4MDsGA1UdEQQ0MDKC
GCoudGFza2NsdXN0ZXItd29ya2VyLm5ldIIWdGFza2NsdXN0ZXItd29ya2VyLm5l
dDAOBgNVHQ8BAf8EBAMCBaAwHQYDVR0lBBYwFAYIKwYBBQUHAwEGCCsGAQUFBwMC
MIGfBgNVHR8EgZcwgZQwSKBGoESGQmh0dHA6Ly9jcmwzLmRpZ2ljZXJ0LmNvbS9E
aWdpQ2VydEdsb2JhbEcyVExTUlNBU0hBMjU2MjAyMENBMS0xLmNybDBIoEagRIZC
aHR0cDovL2NybDQuZGlnaWNlcnQuY29tL0RpZ2lDZXJ0R2xvYmFsRzJUTFNSU0FT
SEEyNTYyMDIwQ0ExLTEuY3JsMD4GA1UdIAQ3MDUwMwYGZ4EMAQICMCkwJwYIKwYB
BQUHAgEWG2h0dHA6Ly93d3cuZGlnaWNlcnQuY29tL0NQUzCBhwYIKwYBBQUHAQEE
ezB5MCQGCCsGAQUFBzABhhhodHRwOi8vb2NzcC5kaWdpY2VydC5jb20wUQYIKwYB
BQUHMAKGRWh0dHA6Ly9jYWNlcnRzLmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEdsb2Jh
bEcyVExTUlNBU0hBMjU2MjAyMENBMS0xLmNydDAJBgNVHRMEAjAAMIIBfwYKKwYB
BAHWeQIEAgSCAW8EggFrAWkAdwDuzdBk1dsazsVct520zROiModGfLzs3sNRSFlG
cR+1mwAAAYi2kC4VAAAEAwBIMEYCIQD8SrNYJGTd+tHu33bDSGX/OLPd8RCj/d5F
aLAwhDr3FwIhAOIUDlLKXQlaNZim6YgJyaexWScFqkgiZupZ3+N9kvxHAHYASLDj
a9qmRzQP5WoC+p0w6xxSActW3SyB2bu/qznYhHMAAAGItpAuPgAABAMARzBFAiAH
qgTr9y9AuLWB8fAwm3wVPenCqSJMQ4+6ym5MqU4OeQIhAJqcu9I0Z9FSD2/cI6Ot
jEO05SCIbDL5IA7FEZrl7PaRAHYA2ra/az+1tiKfm8K7XGvocJFxbLtRhIU0vaQ9
MEjX+6sAAAGItpAtvwAABAMARzBFAiACh5YWcD/9/7FOJDdqd5yliAHgfpIQeokZ
+BTHJf359AIhAJrddq/VZzWOtSNHDPE6C7yvbDRe5TUI4CbCsDi8J+WbMA0GCSqG
SIb3DQEBCwUAA4IBAQB7IvTrTb4QnlR4UM5rrjIDIODY6wc68rJgjkj9v8Mi5G0P
L7qNKZtR+Nz5K/IkXdpdcb/5yY/iV4P9cCmruNPkE8pwkHJHPqmY1ib8csO137dT
aRUAhiS7uJXrx64Tf9+nANcWsrhkTZcBjEqxDc/AIY+QE//pPn6pYk9t1zFa/luw
OoUoh8eaCJwqKEt3d9l5bQLYVRCD3T67hzELbRNi/E5CHa9yvfM3huc4c/Nwfsfv
zjlul5/b5/VjhkOxvqLStkJDFdAF/5knRHQwPxsL3+Vn5muBNhU50mrmqf96X/Ro
escye7WTa9FMPXBfpwRVZA+28x8Qw1jnbHi/AJWu
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIEyDCCA7CgAwIBAgIQDPW9BitWAvR6uFAsI8zwZjANBgkqhkiG9w0BAQsFADBh
MQswCQYDVQQGEwJVUzEVMBMGA1UEChMMRGlnaUNlcnQgSW5jMRkwFwYDVQQLExB3
d3cuZGlnaWNlcnQuY29tMSAwHgYDVQQDExdEaWdpQ2VydCBHbG9iYWwgUm9vdCBH
MjAeFw0yMTAzMzAwMDAwMDBaFw0zMTAzMjkyMzU5NTlaMFkxCzAJBgNVBAYTAlVT
MRUwEwYDVQQKEwxEaWdpQ2VydCBJbmMxMzAxBgNVBAMTKkRpZ2lDZXJ0IEdsb2Jh
bCBHMiBUTFMgUlNBIFNIQTI1NiAyMDIwIENBMTCCASIwDQYJKoZIhvcNAQEBBQAD
ggEPADCCAQoCggEBAMz3EGJPprtjb+2QUlbFbSd7ehJWivH0+dbn4Y+9lavyYEEV
cNsSAPonCrVXOFt9slGTcZUOakGUWzUb+nv6u8W+JDD+Vu/E832X4xT1FE3LpxDy
FuqrIvAxIhFhaZAmunjZlx/jfWardUSVc8is/+9dCopZQ+GssjoP80j812s3wWPc
3kbW20X+fSP9kOhRBx5Ro1/tSUZUfyyIxfQTnJcVPAPooTncaQwywa8WV0yUR0J8
osicfebUTVSvQpmowQTCd5zWSOTOEeAqgJnwQ3DPP3Zr0UxJqyRewg2C/Uaoq2yT
zGJSQnWS+Jr6Xl6ysGHlHx+5fwmY6D36g39HaaECAwEAAaOCAYIwggF+MBIGA1Ud
EwEB/wQIMAYBAf8CAQAwHQYDVR0OBBYEFHSFgMBmx9833s+9KTeqAx2+7c0XMB8G
A1UdIwQYMBaAFE4iVCAYlebjbuYP+vq5Eu0GF485MA4GA1UdDwEB/wQEAwIBhjAd
BgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwdgYIKwYBBQUHAQEEajBoMCQG
CCsGAQUFBzABhhhodHRwOi8vb2NzcC5kaWdpY2VydC5jb20wQAYIKwYBBQUHMAKG
NGh0dHA6Ly9jYWNlcnRzLmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEdsb2JhbFJvb3RH
Mi5jcnQwQgYDVR0fBDswOTA3oDWgM4YxaHR0cDovL2NybDMuZGlnaWNlcnQuY29t
L0RpZ2lDZXJ0R2xvYmFsUm9vdEcyLmNybDA9BgNVHSAENjA0MAsGCWCGSAGG/WwC
ATAHBgVngQwBATAIBgZngQwBAgEwCAYGZ4EMAQICMAgGBmeBDAECAzANBgkqhkiG
9w0BAQsFAAOCAQEAkPFwyyiXaZd8dP3A+iZ7U6utzWX9upwGnIrXWkOH7U1MVl+t
wcW1BSAuWdH/SvWgKtiwla3JLko716f2b4gp/DA/JIS7w7d7kwcsr4drdjPtAFVS
slme5LnQ89/nD/7d+MS5EHKBCQRfz5eeLjJ1js+aWNJXMX43AYGyZm0pGrFmCW3R
bpD0ufovARTFXFZkAdl9h6g4U5+LXUZtXMYnhIHUfoyMo5tS58aI7Dd8KvvwVVo4
chDYABPPTHPbqjc1qCmBaZx2vN4Ye5DUys/vZwP9BFohFrH/6j/f3IL16/RZkiMN
JCqVJUzKoZHm1Lesh3Sz8W2jmdv51b2EQJ8HmA==
-----END CERTIFICATE-----' | sudo tee "${CERT_FILE}"

  fi
done

# configure kvm vmware backdoor
# this enables a vmware compatible interface for kvm, and is needed for some fuzzing tasks
cat > /etc/modprobe.d/kvm-backdoor.conf << "EOF"
options kvm enable_vmware_backdoor=y
EOF

sudo shutdown -h now
